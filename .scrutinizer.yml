filter:
    excluded_paths:
    - bin/*
    - vendor/*
    - tests/*
    - config/*
    - docs/*
    - public/*
    - tests/bootstrap.php
    dependency_paths:
    - vendor/*

build_failure_conditions:
- 'patches.label("Spacing").new.count > 1'     # More than 1 new spacing patch

- 'issues.label("coding-style").exists'        # No coding style issues allowed
- 'issues.label("coding-style").new.exists'    # No new coding style issues allowed

- 'issues.label("coding-style").new.count > 1' # More than 1 new coding style issues.
- 'issues.severity(>= MAJOR).new.exists'       # New issues of major or higher severity

- 'project.metric("scrutinizer.quality", < 9)' # Code Quality Rating drops below 9

# Code Coverage decreased from previous inspection by more than 1%
- 'project.metric_change("scrutinizer.test_coverage", < -0.1)'

build:
    services:
      #mariadb: 10.1.40
    environment:
        hosts:
            cake3.world-architects.com: '127.0.0.1'
        redis: true
        node: 10.16.0
        php:
            version: '7.4'
            ini:
                phar.readonly: 'Off'
        #elasticsearch: '6'

    nodes:
        tests-php72:
            environment:
                php:
                    version: '7.2'
                    ini:
                        phar.readonly: 'Off'
            tests:
                override:
                - phive --no-progress install --target ./bin --trust-gpg-keys 0x4AA394086372C20A,0x8E730BA25823D8B5,0x31C7E470E2138192,0x4AA394086372C20A,0x0F9684B8B16B7AB0
                - composer self-update
                - composer --version
                - composer global require hirak/prestissimo --no-plugins
                - composer install --prefer-dist --no-interaction
                - npm install yarn -g
                - chmod -R +x ./bin
                -
                    command: './bin/phpunit --coverage-clover=coverage.xml --bootstrap ./tests/bootstrap.php'
                    coverage:
                        file: 'coverage.xml'
                        format: 'php-clover'

        tests-php73:
            environment:
                php:
                    version: '7.2'
                    ini:
                        phar.readonly: 'Off'
            tests:
                override:
                - phive --no-progress install --target ./bin --trust-gpg-keys 0x4AA394086372C20A,0x8E730BA25823D8B5,0x31C7E470E2138192,0x4AA394086372C20A,0x0F9684B8B16B7AB0
                - composer self-update
                - composer --version
                - composer global require hirak/prestissimo --no-plugins
                - composer install --prefer-dist --no-interaction
                - npm install yarn -g
                - chmod -R +x ./bin
                -
                    command: './bin/phpunit --coverage-clover=coverage.xml --bootstrap ./tests/bootstrap.php'
                    coverage:
                        file: 'coverage.xml'
                        format: 'php-clover'

        tests-php74:
            environment:
                php:
                    version: '7.2'
                    ini:
                        phar.readonly: 'Off'
            tests:
                override:
                - phive --no-progress install --target ./bin --trust-gpg-keys 0x4AA394086372C20A,0x8E730BA25823D8B5,0x31C7E470E2138192,0x4AA394086372C20A,0x0F9684B8B16B7AB0
                - composer self-update
                - composer --version
                - composer global require hirak/prestissimo --no-plugins
                - composer install --prefer-dist --no-interaction
                - npm install yarn -g
                - chmod -R +x ./bin
                -
                    command: './bin/phpunit --coverage-clover=coverage.xml --bootstrap ./tests/bootstrap.php'
                    coverage:
                        file: 'coverage.xml'
                        format: 'php-clover'

        analysis:
            tests:
                override:
                - php-scrutinizer-run --enable-security-analysis
                - phpcs-run --standard=./phpcs.xml ./src
                - phpcs-run --standard=./phpcs.xml ./plugins
